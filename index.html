<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>আল কুরআন ওয়েব</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Noto+Sans+Bengali:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-color: #EFEADD;
            --header-bg: #E4DECF;
            --text-dark: #2C2C2C;
            --text-light: #5A5A5A;
            --accent-color: #388E3C;
            --border-color: #D6D0C4;
            --player-bg: #DCD6C7;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Noto Sans Bengali', sans-serif;
        }

        body {
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
        }

        #app-container {
            width: 100%;
            max-width: 480px;
            height: 100vh;
            background-color: var(--bg-color);
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* --- Index View --- */
        #index-view {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .header-top {
            background-color: var(--header-bg);
            padding: 15px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            color: var(--text-dark);
            border-bottom: 1px solid var(--border-color);
        }

        .search-container {
            padding: 15px;
            background-color: var(--bg-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .search-bar {
            width: 100%;
            padding: 12px 15px;
            border-radius: 20px;
            border: none;
            background-color: #DFD9CB;
            font-size: 16px;
            outline: none;
            color: var(--text-dark);
        }

        .surah-list {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 20px;
        }

        .surah-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.2s;
        }

        .surah-item:hover {
            background-color: #E4DECF;
        }

        .surah-number {
            font-size: 18px;
            width: 40px;
            color: var(--text-dark);
        }

        .surah-info {
            flex: 1;
        }

        .surah-name {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 5px;
        }

        .surah-meta {
            font-size: 14px;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .surah-action {
            width: 40px;
            text-align: right;
            color: var(--text-dark);
            font-size: 18px;
        }

        /* --- Detail View --- */
        #detail-view {
            height: 100%;
            display: none;
            flex-direction: column;
        }

        .detail-header {
            background-color: var(--header-bg);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }

        .header-title {
            text-align: center;
        }

        .header-title h2 {
            font-size: 20px;
            color: var(--text-dark);
        }

        .header-title p {
            font-size: 12px;
            color: var(--text-light);
        }

        .header-icon {
            font-size: 20px;
            cursor: pointer;
            color: var(--text-dark);
            padding: 5px;
        }

        .bismillah-box {
            margin: 15px;
            border: 1px solid var(--text-dark);
            padding: 10px;
            text-align: center;
            border-radius: 5px;
            font-family: 'Amiri', serif;
            font-size: 24px;
        }

        .ayah-list {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 110px; 
        }

        .ayah-item {
            padding: 20px 15px;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.3s;
        }

        .ayah-item.active {
            background-color: #E2EEDB;
        }

        .ayah-top {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .arabic-text {
            font-family: 'Amiri', serif;
            font-size: 32px;
            text-align: right;
            line-height: 1.8;
            margin-bottom: 15px;
            color: var(--text-dark);
        }

        .translation-label {
            font-size: 12px;
            color: var(--text-light);
            margin-bottom: 5px;
            border-left: 3px solid var(--accent-color);
            padding-left: 5px;
        }

        .translation-text {
            font-size: 16px;
            color: var(--text-dark);
            line-height: 1.5;
        }

        /* --- Audio Player --- */
        .audio-player {
            position: absolute;
            bottom: 0;
            width: 100%;
            background-color: var(--player-bg);
            padding: 15px;
            border-top: 2px solid var(--accent-color);
            display: flex;
            flex-direction: column;
            border-radius: 20px 20px 0 0;
            z-index: 100;
        }

        .progress-container {
            width: 100%;
            margin-bottom: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #ccc;
            border-radius: 2px;
            cursor: pointer;
            position: relative;
        }

        .progress {
            height: 100%;
            background: var(--accent-color);
            width: 0%;
            border-radius: 2px;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .control-btn {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text-light);
            cursor: pointer;
        }

        .play-btn {
            font-size: 28px;
            color: var(--text-dark);
        }

        .ayah-counter {
            font-size: 14px;
            color: var(--text-light);
            font-weight: bold;
        }

        /* --- Loader --- */
        .loader-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 50px 0;
            color: var(--text-light);
        }
        .fa-spinner {
            margin-bottom: 10px;
            color: var(--accent-color);
        }

    </style>
</head>
<body>

<div id="app-container">
    
    <div id="index-view">
        <div class="header-top">আল কুরআন</div>
        <div class="search-container">
            <input type="text" class="search-bar" id="search-input" placeholder="সূরা খুঁজুন..." onkeyup="searchSurah()">
        </div>
        <div class="surah-list" id="surah-list">
            <div class="loader-container">
                <i class="fas fa-spinner fa-spin fa-2x"></i>
                <p>সূরার তালিকা লোড হচ্ছে...</p>
            </div>
        </div>
    </div>

    <div id="detail-view">
        <div class="detail-header">
            <i class="fas fa-arrow-left header-icon" onclick="showIndex()"></i>
            <div class="header-title">
                <h2 id="header-surah-name">নাম</h2>
                <p id="header-surah-meta">তথ্য</p>
            </div>
            <i class="fas fa-info-circle header-icon"></i>
        </div>

        <div class="ayah-list" id="ayah-list">
            </div>

        <div class="audio-player">
            <div class="progress-container">
                <div class="progress-bar" id="progress-bar" onclick="seekAudio(event)">
                    <div class="progress" id="progress"></div>
                </div>
            </div>
            <div class="controls">
                <span class="ayah-counter" id="current-ayah-num">০</span>
                <button class="control-btn" onclick="prevAyah()"><i class="fas fa-step-backward"></i></button>
                <button class="control-btn play-btn" onclick="togglePlay()"><i class="fas fa-play" id="play-icon"></i></button>
                <button class="control-btn" onclick="stopAudio()"><i class="fas fa-stop"></i></button>
                <button class="control-btn" onclick="nextAyah()"><i class="fas fa-step-forward"></i></button>
                <span class="ayah-counter" id="total-ayah-num">০</span>
            </div>
            <audio id="quran-audio" style="display:none;"></audio>
        </div>
    </div>

</div>

<script>
    // --- State Variables ---
    let allSurahs = [];
    let currentAyahs = [];
    let currentPlayingIndex = 0;
    let isPlaying = false;

    // --- DOM Elements ---
    const surahListDiv = document.getElementById('surah-list');
    const ayahListDiv = document.getElementById('ayah-list');
    const indexView = document.getElementById('index-view');
    const detailView = document.getElementById('detail-view');
    const audioEl = document.getElementById('quran-audio');
    const playIcon = document.getElementById('play-icon');
    const progressBar = document.getElementById('progress');
    const currentAyahNumSpan = document.getElementById('current-ayah-num');
    const totalAyahNumSpan = document.getElementById('total-ayah-num');

    // ১. API থেকে সব সূরার তালিকা নিয়ে আসা
    async function fetchSurahs() {
        try {
            const response = await fetch('https://api.alquran.cloud/v1/surah');
            const data = await response.json();
            allSurahs = data.data;
            renderIndex(allSurahs);
        } catch (error) {
            surahListDiv.innerHTML = '<div style="text-align:center; padding:20px; color:red;">ইন্টারনেট সংযোগ চেক করুন!</div>';
        }
    }

    // ২. সূরার তালিকা রেন্ডার করা
    function renderIndex(surahsToRender) {
        surahListDiv.innerHTML = '';
        surahsToRender.forEach(surah => {
            const div = document.createElement('div');
            div.className = 'surah-item';
            div.onclick = () => openSurah(surah.number, surah.englishName, surah.numberOfAyahs);
            
            // মাক্কী নাকি মাদানী চেক করে আইকন বসানো
            const typeIcon = surah.revelationType === "Meccan" ? "fa-kaaba" : "fa-mosque";
            const typeText = surah.revelationType === "Meccan" ? "মাক্কী" : "মাদানী";

            div.innerHTML = `
                <div class="surah-number">${engToBng(surah.number)}</div>
                <div class="surah-info">
                    <div class="surah-name">${surah.englishName} <span style="font-size:14px; color:#777;">(${surah.name})</span></div>
                    <div class="surah-meta">
                        <i class="fas ${typeIcon}"></i> ${typeText} • আয়াত: ${engToBng(surah.numberOfAyahs)}
                    </div>
                </div>
                <div class="surah-action">
                    <i class="far fa-heart"></i>
                </div>
            `;
            surahListDiv.appendChild(div);
        });
    }

    // সার্চ ফাংশন
    function searchSurah() {
        const query = document.getElementById('search-input').value.toLowerCase();
        const filtered = allSurahs.filter(s => s.englishName.toLowerCase().includes(query) || s.name.includes(query));
        renderIndex(filtered);
    }

    // ৩. নির্দিষ্ট সূরার ভেতরে ঢুকে API থেকে আয়াত আনা (আরবি + বাংলা + অডিও)
    async function openSurah(surahNumber, surahName, totalAyahs) {
        indexView.style.display = 'none';
        detailView.style.display = 'flex';
        
        document.getElementById('header-surah-name').innerText = surahName;
        document.getElementById('header-surah-meta').innerText = `সূরা: ${engToBng(surahNumber)} • আয়াত: ${engToBng(totalAyahs)}`;
        
        ayahListDiv.innerHTML = `
            <div class="loader-container">
                <i class="fas fa-spinner fa-spin fa-2x"></i>
                <p>আয়াতগুলো ইন্টারনেট থেকে লোড হচ্ছে...</p>
            </div>
        `;
        
        stopAudio();
        currentAyahs = [];
        totalAyahNumSpan.innerText = engToBng(totalAyahs);
        currentAyahNumSpan.innerText = engToBng(1);

        try {
            // একসাথে ৩টি এডিশন আনা হচ্ছে: উসমানী আরবি, বাংলা অনুবাদ, আল-আফাসির অডিও
            const response = await fetch(`https://api.alquran.cloud/v1/surah/${surahNumber}/editions/quran-uthmani,bn.bengali,ar.alafasy`);
            const data = await response.json();
            
            const arabicData = data.data[0];
            const bengaliData = data.data[1];
            const audioData = data.data[2];

            // ডাটাগুলো গুছিয়ে currentAyahs এরে-তে রাখা
            currentAyahs = arabicData.ayahs.map((ayah, i) => ({
                id: ayah.numberInSurah,
                arabic: ayah.text,
                translation: bengaliData.ayahs[i].text,
                audioUrl: audioData.ayahs[i].audio
            }));

            renderAyahs(currentAyahs, surahNumber);
            loadAudio(0); // প্রথম আয়াতের অডিও রেডি করা

        } catch (error) {
            ayahListDiv.innerHTML = '<div style="text-align:center; padding:20px; color:red;">ডাটা লোড করতে সমস্যা হয়েছে। আবার চেষ্টা করুন।</div>';
        }
    }

    // ৪. আয়াতগুলো স্ক্রিনে দেখানো
    function renderAyahs(ayahs, surahNumber) {
        let headerHtml = '';
        // ফাতিহা (১) বা তাওবা (৯) ছাড়া সব সূরার শুরুতে বিসমিল্লাহ থাকবে
        if(surahNumber !== 1 && surahNumber !== 9) {
            headerHtml = `
                <div class="bismillah-box">
                    بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ
                </div>`;
        }

        let ayahsHtml = ayahs.map((ayah, index) => {
            // API তে অনেক সময় প্রথম আয়াতের সাথে বিসমিল্লাহ যুক্ত থাকে, সেটা ঠিক করার লজিক
            let arabicText = ayah.arabic;
            if(surahNumber !== 1 && ayah.id === 1 && arabicText.startsWith("بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ ")) {
                arabicText = arabicText.replace("بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ ", "");
            }

            return `
            <div class="ayah-item" id="ayah-${index}">
                <div class="ayah-top">
                    <span><i class="fas fa-ellipsis-h"></i></span>
                    <span>${engToBng(ayah.id)}</span>
                </div>
                <div class="arabic-text">${arabicText} ۝</div>
                <div class="translation-label">বাংলা অনুবাদ</div>
                <div class="translation-text">${ayah.translation}</div>
            </div>
            `;
        }).join('');

        ayahListDiv.innerHTML = headerHtml + ayahsHtml;
    }

    // --- Audio Player Logic ---
    function loadAudio(index) {
        if(index >= currentAyahs.length || index < 0) return;
        currentPlayingIndex = index;
        
        audioEl.src = currentAyahs[index].audioUrl;
        currentAyahNumSpan.innerText = engToBng(currentAyahs[index].id);
        
        // Highlight active ayah
        document.querySelectorAll('.ayah-item').forEach(el => el.classList.remove('active'));
        const activeAyahEl = document.getElementById(`ayah-${index}`);
        if(activeAyahEl) {
            activeAyahEl.classList.add('active');
            activeAyahEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    function togglePlay() {
        if(currentAyahs.length === 0) return; // ডাটা লোড না হলে কাজ করবে না
        if (isPlaying) {
            audioEl.pause();
            playIcon.classList.replace('fa-pause', 'fa-play');
        } else {
            audioEl.play();
            playIcon.classList.replace('fa-play', 'fa-pause');
        }
        isPlaying = !isPlaying;
    }

    function stopAudio() {
        audioEl.pause();
        audioEl.currentTime = 0;
        isPlaying = false;
        playIcon.classList.replace('fa-pause', 'fa-play');
        progressBar.style.width = '0%';
    }

    function nextAyah() {
        if(currentPlayingIndex < currentAyahs.length - 1) {
            loadAudio(currentPlayingIndex + 1);
            if(isPlaying) audioEl.play();
        }
    }

    function prevAyah() {
        if(currentPlayingIndex > 0) {
            loadAudio(currentPlayingIndex - 1);
            if(isPlaying) audioEl.play();
        }
    }

    // Auto next when ayah ends
    audioEl.addEventListener('ended', () => {
        if(currentPlayingIndex < currentAyahs.length - 1) {
            nextAyah();
        } else {
            stopAudio();
        }
    });

    audioEl.addEventListener('timeupdate', () => {
        if(audioEl.duration) {
            const progressPercent = (audioEl.currentTime / audioEl.duration) * 100;
            progressBar.style.width = `${progressPercent}%`;
        }
    });

    function seekAudio(e) {
        if(audioEl.duration) {
            const width = e.target.clientWidth;
            const clickX = e.offsetX;
            audioEl.currentTime = (clickX / width) * audioEl.duration;
        }
    }

    function showIndex() {
        detailView.style.display = 'none';
        indexView.style.display = 'flex';
        stopAudio();
    }

    // Helper: English number to Bengali
    function engToBng(number) {
        const bngNumbers = ['০','১','২','৩','৪','৫','৬','৭','৮','৯'];
        return number.toString().split('').map(n => bngNumbers[n] || n).join('');
    }

    // Initialize App by fetching Surahs
    fetchSurahs();

    // ১. সূরার ভেতরে ঢোকার সময় হিস্টোরিতে একটি স্টেট যোগ করা
    const originalOpenSurah = openSurah;
    openSurah = async function(surahNumber, surahName, totalAyahs) {
    // আগের ফাংশনটি কল করা
    await originalOpenSurah(surahNumber, surahName, totalAyahs);
    
    // হিস্টোরিতে একটি এন্ট্রি পুশ করা যাতে ব্যাক বাটন চাপলে অ্যাপ না কাটে
    history.pushState({view: 'detail'}, '');
    };

    // ২. ফোনের বা ব্রাউজারের ব্যাক বাটন চাপলে কি হবে তা নির্ধারণ করা
    window.onpopstate = function(event) {
    if (detailView.style.display === 'flex') {
        // যদি সূরার ভেতরে থাকে, তবে লিস্টে ফিরে যাবে
        showIndex();
    }
    };

    // ৩. showIndex ফাংশনটি একটু আপডেট করা যাতে ব্যাক করার পর হিস্টোরি ঠিক থাকে
    const originalShowIndex = showIndex;
    showIndex = function() {
    originalShowIndex();
    // যদি ম্যানুয়ালি অ্যাপের ব্যাক বাটন টেপা হয়, তবে হিস্টোরি থেকে স্টেট সরানো
    if(history.state && history.state.view === 'detail') {
        // history.back(); // এটি প্রয়োজন হতে পারে যদি আপনি চান অ্যাপের ব্যাক বাটন আর ফোনের ব্যাক বাটন একই কাজ করুক
    }
    };

</script>
</body>
</html>
